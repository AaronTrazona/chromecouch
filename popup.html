<link href="assets/style.css" rel="stylesheet" type="text/css" />
<script src="assets/jquery.min.js" type="text/javascript"></script> 
<script src="assets/jquery.infieldlabel.js" type="text/javascript"></script> 
<script src="assets/jquery.mustache.js" type="text/javascript"></script> 
<script src="assets/jquery.couch2.js" type="text/javascript"></script> 
<script src="assets/underscore.js" type="text/javascript"></script> 
<script src="assets/couchdata.js" type="text/javascript"></script> 
<div class="header">
  <h1 class="title">Couch Replicator</h1>
</div>
<div id='container'>
  <div class="loading">
    <img alt="Ajax-loader" id="spinner" src="assets/ajax-loader.gif" /> 
    <span>Detecting couchapps on this website...</span>
  </div>
</div>
<center><div id='notification' style="color: #D0312B"></div></center>

<script type="text/javascript">
  var data;
  
  function render( template, target, options ) {
    if ( ! options ) options = {data: {}};
    var html = $.mustache( $( "#" + template + "Template" ).html(), options.data ),
        targetDom = $( "#" + target );
    if( options.append ) {
      targetDom.append( html );
    } else {
      targetDom.html( html );
    }
  }

  function makeRequest(options) {
    var dfd = new jQuery.Deferred();
    chrome.extension.sendRequest({'options': options}, function(resp) {
      resp.ok ? dfd.resolve(resp.data) : dfd.reject(resp.data);
    });
    return dfd.promise();
  }

  var resting = "<span class='rightarrow icon'></span>Provision Server"
    , loading = "<span class='loading icon'></span>Contacting your Couch..."

  function parseCouchApp(url) {
    return {
      host: "http://" + url.split( "/" )[ 2 ],
      db: url.split( '/' )[ 3 ],
      design: unescape( url ).split( '/' )[ 5 ]
    }
  }
  
  function checkForCouch(host, callback) {
    var opts = {url: host + ":5984"};
    $.when( makeRequest(opts) ).then(function(response) {
      response.couchdb ? callback(true) : callback(false);
    }, function(fail) {
      render('form', 'container');
      render('sourceInstructions', 'sourceInstructions');
      render('sourceUrl', 'sourceContainer');
      $("label").inFieldLabels();
    })
  }
  var currentPage;
   
  chrome.tabs.getSelected(null, function(tab) {
    currentPage = parseCouchApp(tab.url);
    checkForCouch(currentPage.host, function(exists) {
      render('form', 'container');
      if(exists) {
        var couchData = new CouchData(currentPage.host + ":5984");
        couchData.loadDatabases().then(function (databases) {
          var list = [];
          _.each(databases, function(ddocs, db) {
            _.each(ddocs, function(ddoc) {
              list.push({database: db, title: ddoc.id.split('_design/')[1]});
            })
          })
          render('dropdown', 'sourceContainer', {data: {options: list}});
          render('target', 'targetContainer');
          $("label", $('#targetContainer')).inFieldLabels();
        });
      } else {
        
      }
    })
  });
  
  function replicate(source, target) {
    $('.button').html(loading);
    
    var parsed = {
      host: "http://" + source.split( "/" )[ 2 ],
      db: source.split( '/' )[ 3 ],
      design: unescape( source ).split( '/' )[ 5 ]
    }
 
    var replication = {"target":target, "source":parsed.host + "/" + parsed.db, "doc_ids":["_design/" + parsed.design]};

    makeRequest({type: "POST", url: "http://" + target.split( "/" )[ 2 ] + "/_replicate", data: replication}).then(function(response) {
      var msg;
      if ("error" in response) msg = response.reason;
      if ("statusText" in response && response.statusText === "error") msg = response.statusText;
      
      if ("doc_write_failures" in response) {
        if (response.doc_write_failures > 0) {
          msg = "Invalid username or password"
        } else {
          msg = 'success!'
        }
      } else {
        msg = JSON.stringify(response);
      }
      $('.button').html(resting);
      $('#notification').html(msg);
    })
  }
  
  function postForm() {
    data = {};
    $(['source', 'target']).each(function(i, input) {
      data[input] = $("#" + input).val();
    })
    replicate(data.source, data.target);
  }

  $("input").keydown(function(e) {
     if(e.keyCode == 13) postForm();
  });

  $('.button').click( postForm );

  // function createDb(db, couch, callback) {
  //   request({method: "GET", uri:couch + "/" + db, headers:headers}, function(err, resp, body) {
  //     var msg = parseResponse(err, resp, body);
  //     if (msg.error && msg.reason === "no_db_file") {
  //       request({method: "PUT", uri:couch + "/" + db, headers:headers}, function(err, resp, body) {
  //          msg = parseResponse(err, resp, body);
  //          callback(msg);
  //        });
  //     } else {
  //       callback(msg);
  //     }
  //   });
  // }
  // 
  
</script>

<script id="dropdownTemplate" type="text/mustache">
  <div class="dropdown_filter">
    <span class='show_me'>Replicate from:</span>
    <select class='select'>
    {{#options}}
      <option value='{{title}}'>{{database}}/{{title}}</option>
    {{/options}}
    </select>      
  </div>
</script>

<script id="formTemplate" type="text/mustache">
  <form accept-charset="UTF-8">
    <p id="sourceInstructions" class="instructions" ></p>
    <p id="sourceContainer"    class="url_container"></p>
    <div id="targetContainer"></div>
    <div class="credentials"></div>
  </form>
</script>

<script id="sourceInstructionsTemplate" type="text/mustache">
  Could not find any couchapps on this website :( <br />
  You can manually enter a couchapp url <br />example: <strong>http://maxogden.com/blog/_design/blog</strong>
</script>

<script id="sourceUrlTemplate" type="text/mustache">
  <label for="source">CouchApp URL</label>
  <input id="source" class="long" size="40" type="text" />
</script>

<script id="targetTemplate" type="text/mustache">
  <p class="instructions">
    Replicate to:
  </p>
  <p class="url_container">
    <label for="target">Your Couch</label> 
    <input id="target" class="long" size="40" type="text" />
  </p>
  <br />example destination: <strong>http://localhost:5984/blog</strong>
</script>

<script id="submitTemplate" type="text/mustache"> 
  <p class='submit'> 
    <a href="javascript:void(false)" class="large primary button"><span class="rightarrow icon"></span>Replicate!</a> 
  </p>
</script>

<script id="credentialsTemplate" type="text/mustache">
  <p> 
    <label for="username">Username</label> 
    <input id="username" class="short" size="30" type="text" /> 
  </p>
  <p> 
    <label for="password">Password</label> 
    <input id="password" class="short" size="30" type="password" /> 
  </p>
</script>